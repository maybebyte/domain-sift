name: Update TLD List

on:
  schedule:
    # runs on Monday at 9:00 AM.
    - cron: "0 9 * * 1"
  workflow_dispatch: # Allow manual trigger

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  update-tlds:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Download TLD list and MD5 checksum
        run: |
          set -euo pipefail
          curl -sSLf --retry 3 https://data.iana.org/TLD/tlds-alpha-by-domain.txt -o /tmp/tlds-alpha-by-domain.txt
          curl -sSLf --retry 3 https://data.iana.org/TLD/tlds-alpha-by-domain.txt.md5 -o /tmp/tlds-alpha-by-domain.txt.md5

      - name: Verify MD5 checksum
        run: |
          set -euo pipefail
          cd /tmp
          md5sum -c tlds-alpha-by-domain.txt.md5

      - name: Validate TLD file format
        run: |
          set -euo pipefail
          readonly FILE="/tmp/tlds-alpha-by-domain.txt"
          readonly MIN_TLD_COUNT=1200

          # Validate header format (strict - matches entire line)
          readonly HEADER_REGEX='^#[ \t]+Version[ \t]+[0-9]{10},[ \t]+Last[ \t]+Updated[ \t]+(Mon|Tue|Wed|Thu|Fri|Sat|Sun)[ \t]+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[ \t]+[0-9]{1,2}[ \t]+[0-9]{2}:[0-9]{2}:[0-9]{2}[ \t]+[0-9]{4}[ \t]+UTC$'
          if ! head -1 "${FILE}" | grep -qE "${HEADER_REGEX}"; then
            printf '%s\n' "ERROR: Invalid header format" >&2
            printf '%s\n' "Expected format: # Version NNNNNNNNNN, Last Updated Day Mon DD HH:MM:SS YYYY UTC" >&2
            printf 'Got: %s\n' "$(head -1 "${FILE}")" >&2
            exit 1
          fi

          # Validate all TLD lines (uppercase alpha with optional hyphens/numbers)
          invalid="$(tail -n +2 "${FILE}" | grep -v '^$' | grep -vE '^[A-Z][A-Z0-9-]*$' || true)"
          if [[ -n "${invalid}" ]]; then
            printf '%s\n' "ERROR: Invalid TLD format found:" >&2
            printf '%s\n' "${invalid}" >&2
            exit 1
          fi

          # Ensure minimum TLD count
          count="$(tail -n +2 "${FILE}" | grep -v '^$' | wc -l || true)"
          if ((count < MIN_TLD_COUNT)); then
            printf '%s\n' "ERROR: TLD count ${count} is below minimum threshold of ${MIN_TLD_COUNT}" >&2
            exit 1
          fi
          printf '%s\n' "Validation passed: ${count} TLDs"

      - name: Check for actual TLD changes
        id: check-changes
        run: |
          set -euo pipefail
          readonly NEW_FILE="/tmp/tlds-alpha-by-domain.txt"
          readonly OLD_FILE="lib/Domain/Sift/tlds.txt"

          # Compare content excluding header line
          new_tlds="$(tail -n +2 "${NEW_FILE}" | sort)"
          old_tlds="$(tail -n +2 "${OLD_FILE}" | sort)"

          if [[ "${new_tlds}" == "${old_tlds}" ]]; then
            printf '%s\n' "has_changes=false" >> "${GITHUB_OUTPUT}"
            printf '%s\n' "No TLD changes detected (header-only update)"
          else
            printf '%s\n' "has_changes=true" >> "${GITHUB_OUTPUT}"
            printf '%s\n' "TLD changes detected"
          fi

      - name: Update TLD file
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          set -euo pipefail
          cp -- /tmp/tlds-alpha-by-domain.txt lib/Domain/Sift/tlds.txt

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@84ae59a2cdc2258d6fa0732dd66352dddae2a412 # v7.0.9
        with:
          commit-message: "automation(tlds.txt): detected change in remote TLD list, syncing"
          branch: automation/update-tlds
          delete-branch: true
          title: "automation(tlds.txt): sync TLD list with upstream IANA"
          labels: |
            automation
            dependencies
          body: |
            Automated update of TLD list from IANA.

            Source: https://data.iana.org/TLD/tlds-alpha-by-domain.txt
